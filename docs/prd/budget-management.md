# PRD: 프로젝트 예산관리

## 1. 목적
PM(Project Manager)이 설비 제작/설치 프로젝트의 예산을 단계별로 작성, 확정, 이력 관리할 수 있는 예산관리 기능을 제공한다.

## 2. 범위
- 포함
  - 프로젝트별 예산 버전 관리(초안/확정/리비전)
  - 재료비/인건비/경비 입력 및 자동 합계 계산
  - 엑셀 업로드/다운로드(양식 수식 포함)
  - 문서화(PDF 내보내기) 지원
  - 권한(Role) 기반 편집/확정 제어
- 제외
  - 그룹웨어 결재 시스템 자체 구현(외부 결재 사용)

## 3. 사용자 및 권한
- PM: 예산 작성/수정, 리비전 생성
- Reviewer(상급자): 검토 단계 확정
- Admin: 단가/공식/권한 정책 관리

## 4. 핵심 요구사항

### BM-REQ-001: 단계 기반 버전 관리
- [AC-1] 예산 버전 상태는 `draft`, `confirmed`, `revision`을 가진다.
- [AC-2] 프로젝트 단계(`검토`, `진행`, `종료`)별로 각각 확정 이력을 남길 수 있다.
- [AC-3] `confirmed` 이후 변경 시 리비전 생성 및 변경 사유 입력이 필수다.
- [AC-4] 버전 비교 화면에서 추가/수정/삭제 항목을 하이라이트한다.

### BM-REQ-002: 예산 구조 및 집계
- [AC-1] 한 프로젝트에 다수 설비를 가질 수 있다.
- [AC-2] 비용은 `재료비`, `인건비`, `경비`로 구분한다.
- [AC-3] 각 비용은 `제작`, `설치` 축으로 구분해 집계한다.
- [AC-4] 대시보드에서 총액/설비별 비중/항목별 비중을 제공한다.

### BM-REQ-003: 재료비 계층 관리
- [AC-1] `설비 > 유닛 > 부품` 3단계 구조로 입력/조회 가능하다.
- [AC-2] 부품 단가/수량 변경 시 부품합계, 유닛합계, 설비합계, 프로젝트합계가 즉시 재계산된다.

### BM-REQ-004: 인건비 자동 환산
- [AC-1] 단위 `H/D/W/M`를 지원한다.
- [AC-2] 단위 전환 시 기준 단가를 이용해 자동 환산한다.
- [AC-3] 기준 단가/환산계수는 시스템 설정에서 관리한다.

### BM-REQ-005: 경비 자동 계산
- [AC-1] 경비는 인건비, 작업장소, 작업기간과 연동된 공식으로 계산된다.
- [AC-2] 경비 공식은 관리자 설정으로 변경 가능하다.

### BM-REQ-006: 엑셀 업로드/다운로드
- [AC-1] 현재 예산 데이터를 템플릿 엑셀로 내보낼 수 있다.
- [AC-2] 템플릿에는 합계/소계 수식이 사전 삽입되어 있어야 한다.
- [AC-3] 내보낸 파일을 수정 후 재업로드하면 해당 버전에 반영된다.
- [AC-4] 업로드 오류(필수값 누락, 형식 오류)는 셀 위치와 함께 반환된다.

### BM-REQ-007: 문서화(PDF)
- [AC-1] 버전별 예산 요약/상세를 PDF로 내보낼 수 있다.
- [AC-2] 외부 결재용 출력물로 사용 가능한 레이아웃을 제공한다.

## 5. 데이터 모델(초안)
- `projects`: 프로젝트 기본 정보
- `budget_versions`: 단계/상태/리비전/변경사유
- `budget_equipment`: 설비 단위 예산
- `budget_material_items`: 설비/유닛/부품 항목
- `budget_labor_items`: 인건비 항목(단위 환산 정보 포함)
- `budget_expense_items`: 경비 항목(공식 버전 포함)
- `budget_exports`: 엑셀/PDF 산출 기록

## 6. 화면 구성
- `/budget-management` 대시보드
  - 프로젝트 선택
  - 현재 단계/버전 카드
  - 예산 요약(총액, 항목 비중)
  - 최근 리비전/확정 로그
- 상세 입력 화면(후속)
  - 재료비/인건비/경비 탭
  - 실시간 계산 및 검증
  - 엑셀 업로드/다운로드

## 7. API 초안
- `GET /budget/projects`
- `GET /budget/projects/{project_id}/versions`
- `POST /budget/projects/{project_id}/versions`
- `POST /budget/versions/{version_id}/confirm`
- `POST /budget/versions/{version_id}/revision`
- `POST /budget/versions/{version_id}/import-excel`
- `GET /budget/versions/{version_id}/export-excel`
- `GET /budget/versions/{version_id}/export-pdf`

## 8. 비기능 요구사항
- 감사 추적: 주요 변경(확정/리비전/삭제) 로그 필수
- 동시성: 동일 버전 동시 수정 충돌 감지
- 성능: 엑셀 5,000행 업로드 기준 30초 이내 파싱/검증
- 보안: 프로젝트 접근 권한 및 역할 기반 제어

## 9. 단계별 구현 제안
1. Phase 1: 대시보드/버전 수명주기/요약 집계
2. Phase 2: 재료비/인건비/경비 상세 입력 및 계산 엔진
3. Phase 3: 엑셀 왕복(내보내기/업로드) + 검증 리포트
4. Phase 4: PDF 출력 + 운영 로그/권한 고도화
